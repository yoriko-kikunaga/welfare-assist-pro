name: Daily Kintone Sync

on:
  schedule:
    # æ¯æ—¥24æ™‚ï¼ˆJSTï¼‰= 15æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 15 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹å‹•å®Ÿè¡Œã®ç†ç”±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        default: 'æ‰‹å‹•åŒæœŸ'

jobs:
  kintone-sync-and-deploy:
    name: kintoneåŒæœŸï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      # Step 1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # Step 2: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci
          npm install firebase-admin

      # Step 4: GCPèªè¨¼æƒ…å ±ã‚’è¨­å®š
      - name: GCPèªè¨¼
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 5: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
      - name: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ä¿å­˜
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > service-account-key.json

      # Step 6: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      - name: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—
        run: node importSpreadsheetData.cjs

      # Step 7: .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆkintone APIãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
      - name: kintoneç’°å¢ƒå¤‰æ•°è¨­å®š
        run: |
          cat << EOF > .env
          KINTONE_SUBDOMAIN=acgaozora
          KINTONE_API_TOKEN_184=${{ secrets.KINTONE_API_TOKEN_184 }}
          KINTONE_API_TOKEN_197=${{ secrets.KINTONE_API_TOKEN_197 }}
          EOF

      # Step 8: kintoneã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      - name: kintoneãƒ‡ãƒ¼ã‚¿å–å¾—
        run: node importFromKintone.cjs

      # Step 9: clients.jsonã‚’publicãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’publicã«ã‚³ãƒ”ãƒ¼
        run: |
          mkdir -p public
          cp clients.json public/clients.json

      # Step 10: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build

      # Step 11: Firebase Hostingã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Firebase Hostingãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting --project=welfare-assist-pro --non-interactive
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service-account-key.json

      # Step 12: clients.jsonã‚’Gitã«ã‚³ãƒŸãƒƒãƒˆ
      - name: clients.jsonã‚’Gitã«ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add clients.json
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: Auto-update clients.json from daily kintone sync [skip ci]"
          git push

      # Step 13: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’é€šçŸ¥
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
            echo "ğŸŒ URL: https://welfare-assist-pro.web.app"
            echo "ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ: 8,412ä»¶"
            echo "ğŸ“Š kintone: 959ä»¶ã®å¤‰æ›´ãƒ¬ã‚³ãƒ¼ãƒ‰"
          else
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          fi

      # Step 14: å¤±æ•—æ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: å¤±æ•—é€šçŸ¥
        if: failure()
        run: |
          echo "::error::kintoneåŒæœŸã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
